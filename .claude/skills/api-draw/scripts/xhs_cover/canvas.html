<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°çº¢ä¹¦å°é¢ç”»å¸ƒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 30px;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        .canvas-wrapper {
            flex-shrink: 0;
        }
        .canvas-label {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .canvas {
            width: 360px;
            height: 480px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .region {
            position: absolute;
            left: 0;
            right: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            border: 2px dashed transparent;
        }
        .region:hover {
            border-color: #ff6b6b;
            background: rgba(255,107,107,0.05);
        }
        .region.active {
            border-color: #ff6b6b;
            background: rgba(255,107,107,0.1);
        }
        .region-image {
            top: 0;
            height: 60%;
            background: #fafafa;
        }
        .region-text {
            top: 60%;
            height: 40%;
            background: #fff;
            border-top: 1px solid #eee;
        }
        .region-placeholder {
            color: #999;
            font-size: 14px;
            text-align: center;
            padding: 20px;
        }
        .region-placeholder .icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        .region-content {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }
        .region-content.visible {
            display: block;
        }
        .region-text-content {
            padding: 15px;
            text-align: center;
            display: none;
        }
        .region-text-content.visible {
            display: block;
        }
        .region-text-content h2 {
            font-size: 20px;
            color: #1a1a1a;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .region-text-content p {
            font-size: 14px;
            color: #555;
            margin-bottom: 8px;
        }
        .region-text-content .tags {
            font-size: 12px;
            color: #888;
        }
        .divider {
            position: absolute;
            left: 0;
            right: 0;
            top: 60%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #ff6b6b, transparent);
        }
        .panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .panel h3 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            color: #666;
            font-size: 14px;
            margin-bottom: 6px;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #ff6b6b;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #ff6b6b;
            color: white;
        }
        .btn-primary:hover {
            background: #ff5252;
        }
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: #f0f0f0;
            color: #666;
            margin-left: 10px;
        }
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        .style-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .style-option {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .style-option:hover {
            border-color: #ff6b6b;
        }
        .style-option.selected {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
        }
        .loading {
            display: none;
            align-items: center;
            gap: 10px;
            color: #666;
            margin-top: 10px;
        }
        .loading.visible {
            display: flex;
        }
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-top-color: #ff6b6b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .actions {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            display: none;
        }
        .status.success {
            display: block;
            background: #e8f5e9;
            color: #2e7d32;
        }
        .status.error {
            display: block;
            background: #ffebee;
            color: #c62828;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <h1>å°çº¢ä¹¦å°é¢ç”»å¸ƒ</h1>
    <p style="text-align:center;color:#666;margin-bottom:20px;">ç‚¹å‡»åŒºåŸŸå¡«å……å†…å®¹ | å°ºå¯¸: 1080 x 1440 (3:4)</p>

    <div class="container">
        <div class="canvas-wrapper">
            <div class="canvas-label">é¢„è§ˆ (ç¼©æ”¾ 1:3)</div>
            <div class="canvas" id="canvas">
                <div class="region region-image" id="region-image" onclick="selectRegion('image')">
                    <div class="region-placeholder" id="placeholder-image">
                        <div class="icon">ğŸ–¼ï¸</div>
                        <div>ç‚¹å‡»æ·»åŠ å›¾ç‰‡<br><small>AI ç”Ÿå›¾ / ä¸Šä¼ </small></div>
                    </div>
                    <img class="region-content" id="content-image" />
                </div>
                <div class="divider"></div>
                <div class="region region-text" id="region-text" onclick="selectRegion('text')">
                    <div class="region-placeholder" id="placeholder-text">
                        <div class="icon">âœï¸</div>
                        <div>ç‚¹å‡»æ·»åŠ æ–‡å­—<br><small>æ ‡é¢˜ / å‰¯æ ‡é¢˜ / æ ‡ç­¾</small></div>
                    </div>
                    <div class="region-text-content" id="content-text">
                        <h2 id="display-title"></h2>
                        <p id="display-subtitle"></p>
                        <div class="tags" id="display-tags"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <!-- å›¾ç‰‡åŒºåŸŸé¢æ¿ -->
            <div id="panel-image">
                <h3>ğŸ–¼ï¸ å›¾ç‰‡åŒºåŸŸ (ä¸Šæ–¹ 60%)</h3>

                <div class="form-group">
                    <label>ç”Ÿæˆæ–¹å¼</label>
                    <select id="image-mode" onchange="toggleImageMode()">
                        <option value="generate">AI ç”Ÿå›¾</option>
                        <option value="upload">ä¸Šä¼ å›¾ç‰‡</option>
                    </select>
                </div>

                <div id="generate-options">
                    <div class="form-group">
                        <label>å›¾ç‰‡æè¿° (Prompt)</label>
                        <textarea id="image-prompt" placeholder="ä¾‹å¦‚ï¼šä¸€ä¸ªå¯çˆ±çš„æœºå™¨äººåŠ©æ‰‹ï¼Œç™½è‰²èƒŒæ™¯ï¼Œç®€æ´çº¿æ¡é£æ ¼"></textarea>
                    </div>

                    <div class="form-group">
                        <label>é£æ ¼</label>
                        <div class="style-options">
                            <div class="style-option selected" data-style="æ‰‹ç»˜ç™½æ¿" onclick="selectStyle(this)">æ‰‹ç»˜ç™½æ¿</div>
                            <div class="style-option" data-style="çº¿åˆ»è‚–åƒ" onclick="selectStyle(this)">çº¿åˆ»è‚–åƒ</div>
                            <div class="style-option" data-style="æ¿ä¹¦æ’ç”»" onclick="selectStyle(this)">æ¿ä¹¦æ’ç”»</div>
                            <div class="style-option" data-style="å­¦éœ¸ç¬”è®°" onclick="selectStyle(this)">å­¦éœ¸ç¬”è®°</div>
                            <div class="style-option" data-style="å¯¹æ¯”æ¼«ç”»" onclick="selectStyle(this)">å¯¹æ¯”æ¼«ç”»</div>
                            <div class="style-option" data-style="åŸå§‹é£æ ¼" onclick="selectStyle(this)">åŸå§‹é£æ ¼</div>
                        </div>
                    </div>

                    <div class="form-group" id="ref-image-group" style="display:none;">
                        <label>å‚è€ƒå›¾ç‰‡ï¼ˆçº¿åˆ»è‚–åƒéœ€è¦ï¼‰</label>
                        <input type="file" id="ref-image-file" accept="image/*" />
                        <small style="color:#888;">ä¸Šä¼ äººç‰©ç…§ç‰‡ï¼ŒAI å°†è½¬æ¢ä¸ºçº¿åˆ»é£æ ¼</small>
                    </div>
                </div>

                <div id="upload-options" class="hidden">
                    <div class="form-group">
                        <label>é€‰æ‹©å›¾ç‰‡</label>
                        <input type="file" id="image-file" accept="image/*" onchange="handleFileSelect()" />
                    </div>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="remove-bg" /> è‡ªåŠ¨æŠ å›¾ï¼ˆå»é™¤ç™½è‰²èƒŒæ™¯ï¼‰
                    </label>
                </div>

                <div>
                    <button class="btn btn-primary" id="btn-generate" onclick="generateImage()">ç”Ÿæˆå›¾ç‰‡</button>
                    <button class="btn btn-secondary" onclick="selectRegion('text')">ä¸‹ä¸€æ­¥: æ–‡å­—</button>
                </div>

                <div class="loading" id="loading-image">
                    <div class="spinner"></div>
                    <span>æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...</span>
                </div>
            </div>

            <!-- æ–‡å­—åŒºåŸŸé¢æ¿ -->
            <div id="panel-text" class="hidden">
                <h3>âœï¸ æ–‡å­—åŒºåŸŸ (ä¸‹æ–¹ 40%)</h3>

                <div class="form-group">
                    <label>æ ‡é¢˜</label>
                    <input type="text" id="text-title" placeholder="è¾“å…¥ä¸»æ ‡é¢˜..." oninput="updateTextPreview()" />
                </div>

                <div class="form-group">
                    <label>å‰¯æ ‡é¢˜</label>
                    <input type="text" id="text-subtitle" placeholder="è¾“å…¥å‰¯æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰..." oninput="updateTextPreview()" />
                </div>

                <div class="form-group">
                    <label>æ ‡ç­¾</label>
                    <input type="text" id="text-tags" placeholder="#æ ‡ç­¾1 #æ ‡ç­¾2" oninput="updateTextPreview()" />
                </div>

                <div>
                    <button class="btn btn-secondary" onclick="selectRegion('image')">ä¸Šä¸€æ­¥: å›¾ç‰‡</button>
                    <button class="btn btn-primary" onclick="generateCover()" style="margin-left:10px;">ç”Ÿæˆå°é¢</button>
                </div>
            </div>

            <div class="actions">
                <h3>ğŸ“¤ å¯¼å‡º</h3>
                <button class="btn btn-primary" onclick="exportCover()" id="btn-export" disabled>å¯¼å‡ºå°é¢ (PNG)</button>
                <div class="status" id="status"></div>
            </div>
        </div>
    </div>

    <script>
        // æœåŠ¡ç«¯åœ°å€
        const API_BASE = 'http://localhost:7861';

        // çŠ¶æ€
        let currentRegion = 'image';
        let selectedStyle = 'æ‰‹ç»˜ç™½æ¿';
        let imageData = null;
        let coverGenerated = false;

        function selectRegion(region) {
            currentRegion = region;

            // æ›´æ–°åŒºåŸŸé«˜äº®
            document.querySelectorAll('.region').forEach(el => el.classList.remove('active'));
            document.getElementById('region-' + region).classList.add('active');

            // åˆ‡æ¢é¢æ¿
            document.getElementById('panel-image').classList.toggle('hidden', region !== 'image');
            document.getElementById('panel-text').classList.toggle('hidden', region !== 'text');
        }

        function selectStyle(el) {
            document.querySelectorAll('.style-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            selectedStyle = el.dataset.style;

            // çº¿åˆ»è‚–åƒéœ€è¦å‚è€ƒå›¾
            const refGroup = document.getElementById('ref-image-group');
            if (selectedStyle === 'çº¿åˆ»è‚–åƒ') {
                refGroup.style.display = 'block';
            } else {
                refGroup.style.display = 'none';
            }
        }

        function toggleImageMode() {
            const mode = document.getElementById('image-mode').value;
            document.getElementById('generate-options').classList.toggle('hidden', mode !== 'generate');
            document.getElementById('upload-options').classList.toggle('hidden', mode !== 'upload');
            document.getElementById('btn-generate').textContent = mode === 'generate' ? 'ç”Ÿæˆå›¾ç‰‡' : 'ç¡®è®¤ä¸Šä¼ ';
        }

        function handleFileSelect() {
            const file = document.getElementById('image-file').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    showImage(e.target.result);
                    imageData = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function showImage(src) {
            const img = document.getElementById('content-image');
            img.src = src;
            img.classList.add('visible');
            document.getElementById('placeholder-image').classList.add('hidden');
        }

        function updateTextPreview() {
            const title = document.getElementById('text-title').value;
            const subtitle = document.getElementById('text-subtitle').value;
            const tags = document.getElementById('text-tags').value;

            if (title || subtitle || tags) {
                document.getElementById('display-title').textContent = title;
                document.getElementById('display-subtitle').textContent = subtitle;
                document.getElementById('display-tags').textContent = tags;
                document.getElementById('content-text').classList.add('visible');
                document.getElementById('placeholder-text').classList.add('hidden');
            } else {
                document.getElementById('content-text').classList.remove('visible');
                document.getElementById('placeholder-text').classList.remove('hidden');
            }
        }

        async function generateImage() {
            const mode = document.getElementById('image-mode').value;

            if (mode === 'upload') {
                // ä¸Šä¼ æ¨¡å¼ï¼Œå›¾ç‰‡å·²ç»åœ¨ handleFileSelect ä¸­å¤„ç†
                showStatus('å›¾ç‰‡å·²ä¸Šä¼ ', 'success');
                return;
            }

            const prompt = document.getElementById('image-prompt').value;
            if (!prompt) {
                showStatus('è¯·è¾“å…¥å›¾ç‰‡æè¿°', 'error');
                return;
            }

            // çº¿åˆ»è‚–åƒéœ€è¦å‚è€ƒå›¾
            let refImageBase64 = null;
            if (selectedStyle === 'çº¿åˆ»è‚–åƒ') {
                const refFile = document.getElementById('ref-image-file').files[0];
                if (refFile) {
                    refImageBase64 = await fileToBase64(refFile);
                }
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading-image').classList.add('visible');
            document.getElementById('btn-generate').disabled = true;
            showStatus('æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ï¼Œè¯·ç¨å€™...', 'success');

            try {
                const response = await fetch(API_BASE + '/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        style: selectedStyle,
                        remove_bg: document.getElementById('remove-bg').checked,
                        ref_image: refImageBase64
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showImage(result.image_url);
                    imageData = result.image_path;
                    showStatus('å›¾ç‰‡ç”ŸæˆæˆåŠŸ', 'success');
                } else {
                    showStatus('ç”Ÿæˆå¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                showStatus('è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            } finally {
                document.getElementById('loading-image').classList.remove('visible');
                document.getElementById('btn-generate').disabled = false;
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function generateCover() {
            const title = document.getElementById('text-title').value;

            if (!title) {
                showStatus('è¯·è¾“å…¥æ ‡é¢˜', 'error');
                return;
            }

            try {
                const response = await fetch(API_BASE + '/render', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        template: 'hero',
                        image: imageData,
                        title: title,
                        subtitle: document.getElementById('text-subtitle').value,
                        tags: document.getElementById('text-tags').value
                    })
                });

                const result = await response.json();

                if (result.success) {
                    coverGenerated = true;
                    document.getElementById('btn-export').disabled = false;
                    showStatus('å°é¢ç”ŸæˆæˆåŠŸ: ' + result.output, 'success');

                    // æ›´æ–°é¢„è§ˆ
                    if (result.preview_url) {
                        // å¯ä»¥æ›´æ–°æ•´ä¸ªç”»å¸ƒé¢„è§ˆ
                    }
                } else {
                    showStatus('ç”Ÿæˆå¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                showStatus('è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function exportCover() {
            try {
                const response = await fetch(API_BASE + '/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        destination: '~/Desktop/xhs_cover.png'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showStatus('å·²å¯¼å‡ºåˆ°: ' + result.path, 'success');
                } else {
                    showStatus('å¯¼å‡ºå¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                showStatus('è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            }
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
        }

        // åˆå§‹åŒ–
        selectRegion('image');
    </script>
</body>
</html>
