# 视唱练习工具 - 设计文档

> 日期：2026-02-13

## 一、产品定义

**一句话**：导入 MusicXML，以简谱形式显示，支持任意变速播放（钢琴音色）+ 节拍器，学生跟着唱唱名。

### 1.1 核心交互流程

1. 用户上传 MusicXML 文件
2. 解析后以简谱形式渲染到屏幕
3. 用户设置速度（BPM），点击播放
4. 钢琴音色逐音符播放，简谱当前音符高亮滚动，节拍器同步打拍
5. 可随时暂停、调速、跳转

### 1.2 明确不做（V1）

- 不收音、不评估音准
- 不支持五线谱渲染
- 不支持多声部/和弦（只取主旋律）
- 不做用户系统/云存储

## 二、技术方案

### 2.1 技术选型：Tone.js + 自定义简谱渲染

| 模块 | 技术 | 说明 |
|------|------|------|
| MusicXML 解析 | 浏览器原生 DOMParser | MusicXML 就是 XML，直接解析提取音符序列 |
| 钢琴音色 | Tone.js + @tonejs/piano 或 soundfont-player | 加载钢琴 Soundfont 采样 |
| 节拍器 | Tone.js Transport + 合成点击音 | 与音符播放共享同一时钟，天然同步 |
| 变速控制 | Tone.Transport.bpm | 一行代码改 BPM，所有调度自动跟随 |
| 简谱渲染 | SVG（手写渲染逻辑） | 数字 1-7 + 高低八度点 + 时值下划线 + 小节线 |
| 滚动高亮 | CSS transform + requestAnimationFrame | 当前音符高亮，谱面平滑滚动 |

### 2.2 为什么不用 OSMD

OpenSheetMusicDisplay 只渲染五线谱，不支持简谱。得魔改或抛弃其渲染层，等于白引入了一个重量级依赖。简谱渲染逻辑不复杂（本质是排列数字和符号），自己写反而比适配现有库更简单。

## 三、数据流

```
MusicXML 文件
    | DOMParser 解析
    v
内部数据模型 (NoteSequence)
    |
    +-> 简谱渲染器 (SVG) -> 屏幕显示
    +-> 钢琴播放器 (Tone.js Sampler) -> 音频输出
    +-> 节拍器 (Tone.js Loop) -> 节拍音
    +-> 播放指针 (Transport callback) -> 高亮 + 滚动
```

### 3.1 内部数据模型

```ts
interface Note {
  pitch: number;       // MIDI 音高 (60=C4=中央C=do)
  duration: string;    // "4n" "8n" 等 Tone.js 时值
  beat: number;        // 在整首曲子中的拍数位置
  measure: number;     // 所属小节号
  jianpu: string;      // 简谱显示："1" "2" "5" 等
  octaveShift: number; // 相对于基准八度的偏移 (-1, 0, +1)
  isRest: boolean;     // 是否为休止符
  dotted: boolean;     // 是否附点
}
```

### 3.2 简谱渲染规则

| 元素 | 渲染方式 |
|------|----------|
| 音高 | 数字 1-7（do-si），0 = 休止符 |
| 高八度 | 数字上方加点（可叠加） |
| 低八度 | 数字下方加点（可叠加） |
| 八分音符 | 数字下方一条横线 |
| 十六分音符 | 数字下方两条横线 |
| 附点 | 数字右侧加点 |
| 延长 | 数字后加短横 `-` |
| 小节线 | 竖线 |
| 拍号/调号 | 顶部显示，如 `1=C  4/4` |

SVG 渲染：每个音符占一个固定宽度的格子，按小节分组排列。当前播放音符加背景色高亮，整行居中，播放到行末自动滚动到下一行。

## 四、UI 布局

```
+-------------------------------------------+
|  1=C  4/4    BPM=80          [上传文件]   |  <- 信息栏
+-------------------------------------------+
|                                           |
|   1  2  3  1 | 1  2  3  1 |             |
|                                           |  <- 简谱区（主体）
|   3  4  5 - | 3  4  5 - |               |
|                                           |
+-------------------------------------------+
|  [|<] [>/||] [>|]    --o-------- 2:31    |  <- 播放控制
|                                           |
|  速度: [-] ===o======= [+]  BPM=80      |  <- BPM 滑块 (20~200)
|  节拍器: [ON/OFF]     音量: ===o===      |  <- 节拍器 + 音量
+-------------------------------------------+
```

### 4.1 交互细节

- 播放/暂停：空格键快捷键
- 变速：拖拽滑块或 +/- 按钮（步进 5 BPM），范围 20~200 BPM
- 进度条：可拖拽跳转到任意位置，显示当前时间
- 节拍器开关：独立控制，不影响音符播放
- 上传：拖拽或点击上传 .musicxml / .xml 文件
- 点击简谱音符：跳转到该位置开始播放

## 五、技术栈

- **框架**：Vanilla JS + SVG（无需 React/Vue）
- **构建**：Vite
- **音频**：Tone.js + 钢琴 Soundfont
- **部署**：Vercel / Cloudflare Pages 静态托管
- **依赖**：仅 Tone.js 一个运行时依赖
